name: Create UYM Release

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:

  validate:
    if: contains('["yarisvt"]', github.actor)
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.determine_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          architecture: x64
          cache: 'maven'
      - name: Build software
        run: mvn -B install --no-transfer-progress --file pom.xml
      - name: Determine version
        id: determine_version
        run: |
          current_version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current version: ${current_version}"
          echo "version=${current_version}" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION=${current_version}" >> $GITHUB_ENV
      - name: Check if snapshot
        run: |
          echo "Project version is: ${{ env.CURRENT_VERSION }}"
          if [[ "${{ env.CURRENT_VERSION }}" != *"-SNAPSHOT"* ]]; then
            echo "::error::Release version should contain -SNAPSHOT"
            exit 1
          else
            echo "Release version is correct (contains -SNAPSHOT)"
          fi

  release:
    needs: validate
    runs-on: ubuntu-24.04
    outputs:
      tagged: ${{ steps.set_version.outputs.tag_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          architecture: x64
          cache: 'maven'
      - name: Configure Git
        run: |
          git config user.name "Yaris van Thiel"
          git config user.email "yarisvt@users.noreply.github.com"
      - name: Commit release
        run: |
          apt install -qy git ssh
          mkdir -p /root/.ssh
          echo ${{ secrets.SSH_DEPLOYMENT_KEY }} | base64 -d > /root/.ssh/id_rsa
          ssh-keyscan -t rsa github.com  > /root/.ssh/known_hosts
          chmod -R og-rwx /root/.ssh
          mvn clean
          mvn build-helper:parse-version versions:set -DnewVersion='${parsedVersion.majorVersion}.${parsedVersion.minorVersion}.${parsedVersion.incrementalVersion}' versions:update-child-modules versions:commit
          RELEASE_VERSION=$(mvn -q org.apache.maven.plugins:maven-help-plugin:3.1.0:evaluate -DforceStdout -Dexpression=project.version | tr -d '\r\n')
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
          git checkout -b "release-${RELEASE_VERSION}"
          git add .
          git commit -m "chore: Release ${RELEASE_VERSION}"
          git tag -f "${RELEASE_VERSION}"
          mvn build-helper:parse-version versions:set -DnewVersion='${parsedVersion.majorVersion}.${parsedVersion.minorVersion}.${parsedVersion.nextIncrementalVersion}-SNAPSHOT' versions:commit
          NEXT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          git add .
          git commit -m "chore:  prepare snapshot version ${NEXT_VERSION}"
          git branch -f "${BRANCH_NAME}" "origin/${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git merge "release-${RELEASE_VERSION}"
          git branch -D "release-${RELEASE_VERSION}"
          git push
          git push origin "${RELEASE_VERSION}"
      - name: Create Pull Request
        run: |
          gh pr create \
            --title "Release ${{ env.RELEASE_VERSION }}" \
            --body "This PR was created using the GitHub CLI." \
            --base main \
            --head ${{ env.RELEASE_VERSION }}
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

  # Create a release in GitHub with the same version as above created tag
  github-release:
    needs: release
    runs-on: ubuntu-24.04
    if: ${{ needs.release.outputs.tagged }}
    steps:
      - name: Create github release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release.outputs.tagged }}
          name: Release ${{ needs.release.outputs.tagged }}
          draft: true
          prerelease: false
          generate_release_notes: true
